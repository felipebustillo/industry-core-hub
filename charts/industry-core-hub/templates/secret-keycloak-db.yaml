{{- /*
* Eclipse Tractus-X - Industry Core Hub
*
* Copyright (c) 2025 Contributors to the Eclipse Foundation
*
* See the NOTICE file(s) distributed with this work for additional
* information regarding copyright ownership.
*
* This program and the accompanying materials are made available under the
* terms of the Apache License, Version 2.0 which is available at
* https://www.apache.org/licenses/LICENSE-2.0.
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
* WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
* License for the specific language governing permissions and limitations
* under the License.
*
* SPDX-License-Identifier: Apache-2.0
*/}}
{{- if .Values.keycloak.enabled }}
{{- /*
  CloudPirates Keycloak chart expects a secret with keys 'db-username' and 'db-password'.
  This template creates that secret using the ichub_keycloak credentials.
  The password is generated using the shared helper to ensure consistency with the PostgreSQL secret.
  The secret name must match keycloak.database.existingSecret in values.yaml
*/}}
apiVersion: v1
kind: Secret
metadata:
  name: {{ .Values.keycloak.database.existingSecret | default "ichub-keycloak-db" }}
  namespace: {{ .Release.Namespace | default "default" | quote }}
  labels:
    {{- include "industry-core-hub.labels" . | nindent 4 }}
    app.kubernetes.io/component: keycloak
type: Opaque
{{- /*
  Use the shared helper to get the password - this ensures consistency with secret-backend-postgres.yaml
*/}}
{{- $ichubPassword := include "industry-core-hub.postgresql.ichubPassword" . }}
{{- /* Generate the PostgreSQL host dynamically using the existing helper */}}
{{- $postgresHost := include "industry-core-hub.postgresql.fullname" . }}
{{- $postgresPort := .Values.keycloak.database.port | default "5432" }}
{{- $postgresDb := .Values.keycloak.database.name | default "ichub-postgres" }}
stringData:
  db-username: "ichub_keycloak"
  db-password: {{ $ichubPassword | quote }}
  db-host: {{ $postgresHost | quote }}
  db-url: {{ printf "jdbc:postgresql://%s:%s/%s" $postgresHost ($postgresPort | toString) $postgresDb | quote }}
{{- end }}
